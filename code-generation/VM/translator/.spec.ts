import { VMTranslator } from ".";
describe("VM hack translator", () => {
  test("translates dump program well ", () => {
    const vmCode = `push constant 10
push this 1
add
push that 10
push pointer 1
sub
neg
pop temp 2
`;

    const expected = [
      "// init vars",
      "@256",
      "D = A",
      "@SP",
      "M = D",
      "@FP",
      "M = D",
      "\n",
      "// push constant 0",
      "@0",
      "D = A",
      "@SP",
      "A = M",
      "M = D",
      "@SP",
      "M = M+1",
      "\n",
      "// call Main.main 1",
      "@VM_BASE$ret.1",
      "D = A",
      "@SP",
      "A = M",
      "M = D",
      "@LCL",
      "D = M",
      "@SP",
      "M = M+1",
      "A = M",
      "M = D",
      "@ARG",
      "D = M",
      "@SP",
      "M = M+1",
      "A = M",
      "M = D",
      "@THIS",
      "D = M",
      "@SP",
      "M = M+1",
      "A = M",
      "M = D",
      "@THAT",
      "D = M",
      "@SP",
      "M = M+1",
      "A = M",
      "M = D",
      "@FP",
      "D = M",
      "@SP",
      "M = M+1",
      "A = M",
      "M = D",
      "@SP",
      "M = M+1",
      "D = M",
      "@FP",
      "M = D",
      "@ARG",
      "M = D",
      "@7",
      "D = A",
      "@ARG",
      "M = M-D",
      "@Main.main",
      "0; JMP",
      "(VM_BASE$ret.1)",
      "\n",
      "// goto VM_BASE$END",
      "@VM_BASE$END",
      "0; JMP",
      "\n",
      `// push constant 10`,
      `@10`,
      `D = A`,
      `@SP`,
      `A = M`,
      `M = D`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// push this 1`,
      `@1`,
      `D = A`,
      `@THIS`,
      `A = D+M`,
      `D = M`,
      `@SP`,
      `A = M`,
      `M = D`,
      `@SP`,
      `M = M+1`,
      `\n`,

      `// add`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `D = M`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `M = D+M`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// push that 10`,
      `@10`,
      `D = A`,
      `@THAT`,
      `A = D+M`,
      `D = M`,
      `@SP`,
      `A = M`,
      `M = D`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// push pointer 1`,
      `@THAT`,
      `D = M`,
      `@SP`,
      `A = M`,
      `M = D`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// sub`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `D = M`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `M = M-D`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// neg`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `M = -M`,
      `@SP`,
      `M = M+1`,
      `\n`,
      `// pop temp 2`,
      `@7`,
      `D = A`,
      `@R12`,
      `M = D`,
      `@SP`,
      `M = M-1`,
      `A = M`,
      `D = M`,
      `@R12`,
      `A = M`,
      `M = D`,
      `\n`,
      "// label END",
      "(VM_BASE$END)",
      "\n",
      "// goto VM_BASE$END",
      "@VM_BASE$END",
      "0; JMP",
      `\n`,
    ];

    const trans = new VMTranslator();

    trans.code = vmCode;
    trans.filename = "someFile";
    trans.initDir();
    trans.translate();
    trans.end();

    expect(trans.lines).toEqual(expected);
  });
});
